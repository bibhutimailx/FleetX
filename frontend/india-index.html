<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTPC Fleet Management System - India Operations</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        .map-container {
            height: 600px;
            border-radius: 8px;
        }
        .alert-critical {
            border-left: 6px solid #DC2626;
            background-color: #FEF2F2;
            animation: pulse 2s infinite;
        }
        .alert-high {
            border-left: 4px solid #EF4444;
            background-color: #FEF2F2;
        }
        .alert-medium {
            border-left: 4px solid #F59E0B;
            background-color: #FFFBEB;
        }
        .pulse-red {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { 
                background-color: #EF4444;
                transform: scale(1);
            }
            50% { 
                background-color: #DC2626;
                transform: scale(1.05);
            }
        }
        .vehicle-on-route { background-color: #10B981; }
        .vehicle-stopped { background-color: #F59E0B; }
        .vehicle-deviation { background-color: #EF4444; }
        .vehicle-speed-violation { background-color: #DC2626; }
        .vehicle-loading { background-color: #6366F1; }
        .vehicle-arrived { background-color: #8B5CF6; }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .fuel-bar {
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .fuel-critical { background-color: #DC2626; }
        .fuel-low { background-color: #F59E0B; }
        .fuel-normal { background-color: #10B981; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Critical Alert Banner -->
    <div id="critical-alert-banner" class="hidden bg-red-600 text-white px-4 py-3 text-center pulse-red">
        <div class="flex items-center justify-center">
            <i class="fas fa-exclamation-triangle mr-2 text-xl"></i>
            <span id="critical-alert-message" class="font-bold"></span>
            <button onclick="dismissCriticalAlert()" class="ml-4 text-white hover:text-gray-200">‚úï</button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='80' fill='white'%3Eüè≠%3C/text%3E%3C/svg%3E" alt="NTPC" class="w-10 h-10 mr-3">
                    <div>
                        <h1 class="text-2xl font-bold">NTPC Fleet Management System</h1>
                        <p class="text-sm opacity-90">Talcher Super Thermal Power Station ‚Üí Chandilkhol Industrial Area</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-center">
                        <div class="bg-green-500 px-2 py-1 rounded text-xs">üáÆüá≥ LIVE INDIA OPS</div>
                        <div id="last-update" class="mt-1">Loading...</div>
                    </div>
                    <div id="alert-count" class="bg-red-500 px-3 py-2 rounded text-sm hidden pulse-red">
                        <i class="fas fa-bell mr-1"></i>
                        <span id="alert-number">0</span> Alerts
                    </div>
                    <button id="refresh-btn" class="bg-blue-500 hover:bg-blue-700 px-4 py-2 rounded text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <div class="container mx-auto px-4 py-6">
        <!-- Enhanced Stats Dashboard -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow col-span-2 md:col-span-1">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-truck text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Total Fleet</p>
                        <p id="total-vehicles" class="text-2xl font-bold">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-route text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">On Route</p>
                        <p id="on-route" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-pause text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Stopped</p>
                        <p id="stopped" class="text-2xl font-bold text-yellow-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Deviations</p>
                        <p id="deviations" class="text-2xl font-bold text-red-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-orange-100 rounded-lg">
                        <i class="fas fa-tachometer-alt text-orange-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Speed Violations</p>
                        <p id="speed-violations" class="text-2xl font-bold text-orange-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-boxes text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Loaded</p>
                        <p id="loaded-vehicles" class="text-2xl font-bold text-purple-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-indigo-100 rounded-lg">
                        <i class="fas fa-percentage text-indigo-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Avg Progress</p>
                        <p id="avg-progress" class="text-2xl font-bold text-indigo-600">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-cyan-100 rounded-lg">
                        <i class="fas fa-gas-pump text-cyan-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Avg Fuel</p>
                        <p id="avg-fuel" class="text-2xl font-bold text-cyan-600">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map and Critical Alerts -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
            <!-- Enhanced India Map -->
            <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">üó∫Ô∏è NTPC Talcher ‚Üí Chandilkhol Route Tracking</h2>
                    <div class="flex space-x-2">
                        <button id="show-route-btn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            <i class="fas fa-route mr-1"></i> Route
                        </button>
                        <button id="show-pois-btn" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                            <i class="fas fa-gas-pump mr-1"></i> POIs
                        </button>
                        <button id="center-map-btn" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                            <i class="fas fa-crosshairs mr-1"></i> Center
                        </button>
                    </div>
                </div>
                <div id="map" class="map-container"></div>
                <div class="mt-4 grid grid-cols-2 lg:grid-cols-5 gap-2 text-xs">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-800 rounded-full mr-2"></div>
                        <span>NTPC Talcher</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-purple-600 rounded-full mr-2"></div>
                        <span>Chandilkhol</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span>Gas Stations</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
                        <span>Toll Gates</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-400 rounded-full mr-2"></div>
                        <span>Route Path</span>
                    </div>
                </div>
            </div>

            <!-- Critical Alerts Panel -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">üö® Critical Alerts</h2>
                <div id="alerts-list" class="space-y-3">
                    <div class="text-center text-gray-500">Loading alerts...</div>
                </div>
            </div>
        </div>

        <!-- Vehicle Fleet and Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Enhanced Vehicle Fleet -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">üöõ Fleet Status (NTPC Coal Trucks)</h2>
                <div id="vehicle-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500">Loading vehicles...</div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">üìã Real-time Activity Log</h2>
                <div id="activity-log" class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500">Loading activity...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration for India Operations
        const API_BASE_URL = 'http://127.0.0.1:8004';
        
        // Global variables
        let map;
        let vehicleMarkers = {};
        let vehicles = [];
        let alerts = [];
        let routeLayer;
        let plantMarker;
        let destinationMarker;
        let poisVisible = false;
        let poiMarkers = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeIndiaMap();
            loadData();
            setInterval(refreshData, 8000); // Refresh every 8 seconds for real-time monitoring
            
            // Event listeners
            document.getElementById('refresh-btn').addEventListener('click', refreshData);
            document.getElementById('show-route-btn').addEventListener('click', toggleRoute);
            document.getElementById('show-pois-btn').addEventListener('click', togglePOIs);
            document.getElementById('center-map-btn').addEventListener('click', centerMap);
        });

        // Initialize India map centered on Odisha
        function initializeIndiaMap() {
            // Center map between Talcher and Chandilkhol
            map = L.map('map').setView([20.9100, 85.6500], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors | NTPC Fleet Management'
            }).addTo(map);

            // Add NTPC Talcher marker
            plantMarker = L.marker([20.9463, 85.2190], {
                icon: L.divIcon({
                    html: '<div class="bg-blue-800 text-white rounded-lg w-14 h-14 flex items-center justify-center text-lg font-bold shadow-xl border-2 border-white"><i class="fas fa-industry"></i></div>',
                    className: 'plant-marker',
                    iconSize: [56, 56],
                    iconAnchor: [28, 28]
                })
            }).bindPopup(`
                <div class="p-3">
                    <h3 class="font-bold text-blue-800">üè≠ NTPC Talcher Super Thermal Power Station</h3>
                    <p><strong>Location:</strong> Talcher, Angul, Odisha</p>
                    <p><strong>Function:</strong> Coal loading point</p>
                    <p><strong>Capacity:</strong> 3000 MW</p>
                    <p class="text-sm text-gray-500 mt-2">Starting point for all coal transport routes</p>
                </div>
            `).addTo(map);

            // Add Chandilkhol destination marker
            destinationMarker = L.marker([20.8739, 86.0891], {
                icon: L.divIcon({
                    html: '<div class="bg-purple-600 text-white rounded-lg w-14 h-14 flex items-center justify-center text-lg font-bold shadow-xl border-2 border-white"><i class="fas fa-flag-checkered"></i></div>',
                    className: 'destination-marker',
                    iconSize: [56, 56],
                    iconAnchor: [28, 28]
                })
            }).bindPopup(`
                <div class="p-3">
                    <h3 class="font-bold text-purple-600">üèÅ Chandilkhol Industrial Area</h3>
                    <p><strong>Location:</strong> Chandilkhol, Jajpur, Odisha</p>
                    <p><strong>Function:</strong> Coal unloading & distribution</p>
                    <p><strong>Distance:</strong> ~85 km from NTPC Talcher</p>
                    <p class="text-sm text-gray-500 mt-2">Final destination for coal delivery</p>
                </div>
            `).addTo(map);
        }

        // Load all data
        async function loadData() {
            try {
                const [vehiclesResponse, alertsResponse, analyticsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/v1/vehicles/locations`),
                    fetch(`${API_BASE_URL}/api/v1/alerts/`),
                    fetch(`${API_BASE_URL}/api/v1/analytics/summary`)
                ]);
                
                const vehiclesData = await vehiclesResponse.json();
                const alertsData = await alertsResponse.json();
                const analyticsData = await analyticsResponse.json();
                
                vehicles = vehiclesData.locations || [];
                alerts = alertsData.alerts || [];
                
                updateDashboard(analyticsData);
                updateVehicleList();
                updateMap();
                updateAlertsPanel();
                updateActivityLog();
                
                document.getElementById('last-update').textContent = 
                    `Updated: ${new Date().toLocaleTimeString()}`;
                    
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to connect to NTPC Fleet API. Please check server status.');
            }
        }

        // Update enhanced dashboard
        function updateDashboard(analytics) {
            document.getElementById('total-vehicles').textContent = analytics.total_vehicles;
            document.getElementById('on-route').textContent = analytics.on_route;
            document.getElementById('stopped').textContent = analytics.stopped;
            document.getElementById('deviations').textContent = analytics.deviations;
            document.getElementById('speed-violations').textContent = analytics.speed_violations;
            document.getElementById('loaded-vehicles').textContent = analytics.loaded_vehicles;
            document.getElementById('avg-progress').textContent = `${analytics.average_progress.toFixed(1)}%`;
            document.getElementById('avg-fuel').textContent = `${analytics.average_fuel_level.toFixed(1)}%`;
            
            // Update alert count with enhanced styling
            const alertCountEl = document.getElementById('alert-count');
            const alertNumberEl = document.getElementById('alert-number');
            
            if (analytics.active_alerts > 0) {
                alertCountEl.classList.remove('hidden');
                alertNumberEl.textContent = analytics.active_alerts;
                
                // Add pulsing for critical alerts
                const criticalAlerts = alerts.filter(a => a.severity === 'critical');
                if (criticalAlerts.length > 0) {
                    alertCountEl.classList.add('pulse-red');
                    showCriticalAlertBanner(criticalAlerts[0].message);
                } else {
                    alertCountEl.classList.remove('pulse-red');
                }
            } else {
                alertCountEl.classList.add('hidden');
                alertCountEl.classList.remove('pulse-red');
            }
        }

        // Update enhanced vehicle list
        function updateVehicleList() {
            const vehicleList = document.getElementById('vehicle-list');
            
            if (vehicles.length === 0) {
                vehicleList.innerHTML = '<div class="text-center text-gray-500">No vehicles in fleet</div>';
                return;
            }

            vehicleList.innerHTML = vehicles.map(vehicle => {
                const statusClasses = {
                    'on_route': 'text-green-600',
                    'stopped': 'text-yellow-600',
                    'deviation': 'text-red-600',
                    'speed_violation': 'text-red-700',
                    'loading': 'text-blue-600',
                    'arrived': 'text-purple-600'
                };

                const statusColor = statusClasses[vehicle.route_status] || 'text-gray-600';
                
                const fuelClass = vehicle.fuel_level < 15 ? 'fuel-critical' : 
                                vehicle.fuel_level < 30 ? 'fuel-low' : 'fuel-normal';

                return `
                    <div class="border rounded-lg p-3 hover:bg-gray-50 cursor-pointer transition-all" onclick="focusVehicle('${vehicle.vehicle_id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <h3 class="font-semibold text-blue-700">${vehicle.vehicle_id}</h3>
                                    <span class="ml-2 text-xs bg-gray-200 px-2 py-1 rounded">${vehicle.capacity_tons}T</span>
                                </div>
                                <p class="text-sm text-gray-700">${vehicle.driver_name}</p>
                                <p class="text-xs text-gray-500">${vehicle.driver_phone}</p>
                                <div class="flex items-center mt-1">
                                    <span class="status-indicator ${vehicle.route_status === 'on_route' ? 'bg-green-500' : 
                                                                   vehicle.route_status === 'stopped' ? 'bg-yellow-500' :
                                                                   vehicle.route_status === 'deviation' ? 'bg-red-500' :
                                                                   vehicle.route_status === 'speed_violation' ? 'bg-red-600' :
                                                                   vehicle.route_status === 'loading' ? 'bg-blue-500' : 'bg-purple-500'}"></span>
                                    <span class="text-sm ${statusColor} font-medium">${vehicle.route_status.replace('_', ' ').toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold ${vehicle.speed > 60 ? 'text-red-600' : 'text-gray-800'}">${vehicle.speed.toFixed(0)} km/h</div>
                                <div class="text-sm text-gray-600">${vehicle.route_progress.toFixed(1)}% complete</div>
                                ${vehicle.stop_duration > 0 ? `<div class="text-xs text-red-500">Stopped: ${vehicle.stop_duration}m</div>` : ''}
                                <div class="w-16 fuel-bar ${fuelClass} mt-1" title="Fuel: ${vehicle.fuel_level.toFixed(1)}%">
                                    <div class="h-full bg-white" style="width: ${100 - vehicle.fuel_level}%"></div>
                                </div>
                                <div class="text-xs text-gray-500">${vehicle.fuel_level.toFixed(1)}% fuel</div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full transition-all duration-500" style="width: ${vehicle.route_progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update map with enhanced Indian vehicle markers
        function updateMap() {
            // Clear existing vehicle markers
            Object.values(vehicleMarkers).forEach(marker => map.removeLayer(marker));
            vehicleMarkers = {};

            // Add enhanced vehicle markers
            vehicles.forEach(vehicle => {
                const statusClasses = {
                    'on_route': 'vehicle-on-route',
                    'stopped': 'vehicle-stopped',
                    'deviation': 'vehicle-deviation',
                    'speed_violation': 'vehicle-speed-violation',
                    'loading': 'vehicle-loading',
                    'arrived': 'vehicle-arrived'
                };
                
                const statusClass = statusClasses[vehicle.route_status] || 'bg-gray-500';
                const isViolation = vehicle.route_status === 'speed_violation' || vehicle.stop_duration > 30;
                
                const icon = L.divIcon({
                    html: `
                        <div class="${statusClass} text-white rounded-lg w-10 h-10 flex items-center justify-center text-xs font-bold shadow-lg border-2 border-white ${isViolation ? 'pulse-red' : ''}">
                            ${vehicle.vehicle_id.slice(-2)}
                        </div>
                        ${vehicle.fuel_level < 20 ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full pulse-red" title="Low Fuel"></div>' : ''}
                        ${vehicle.stop_duration > 30 ? '<div class="absolute -bottom-1 -right-1 w-3 h-3 bg-red-600 rounded-full pulse-red" title="Extended Stop"></div>' : ''}
                    `,
                    className: 'vehicle-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([vehicle.latitude, vehicle.longitude], { icon })
                    .bindPopup(`
                        <div class="p-4 min-w-64">
                            <h3 class="font-bold text-blue-700 text-lg">${vehicle.vehicle_id}</h3>
                            <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                <div><strong>Driver:</strong><br>${vehicle.driver_name}</div>
                                <div><strong>Phone:</strong><br>${vehicle.driver_phone}</div>
                                <div><strong>Status:</strong><br><span class="font-medium ${vehicle.route_status === 'on_route' ? 'text-green-600' : 
                                                                                         vehicle.route_status === 'stopped' ? 'text-yellow-600' : 'text-red-600'}">${vehicle.route_status.replace('_', ' ').toUpperCase()}</span></div>
                                <div><strong>Load:</strong><br>${vehicle.load_status.toUpperCase()}</div>
                                <div><strong>Speed:</strong><br>${vehicle.speed.toFixed(1)} km/h</div>
                                <div><strong>Progress:</strong><br>${vehicle.route_progress.toFixed(1)}%</div>
                                <div><strong>Fuel:</strong><br><span class="${vehicle.fuel_level < 30 ? 'text-red-600' : 'text-green-600'}">${vehicle.fuel_level.toFixed(1)}%</span></div>
                                <div><strong>Capacity:</strong><br>${vehicle.capacity_tons} Tons</div>
                            </div>
                            ${vehicle.stop_duration > 0 ? `<div class="mt-2 p-2 bg-yellow-100 rounded"><strong>Stopped:</strong> <span class="text-red-600">${vehicle.stop_duration} minutes</span></div>` : ''}
                            <div class="mt-2 text-xs text-gray-500">
                                ETA: ${vehicle.destination_eta ? new Date(vehicle.destination_eta).toLocaleString() : 'Calculating...'}
                            </div>
                        </div>
                    `)
                    .addTo(map);

                vehicleMarkers[vehicle.vehicle_id] = marker;
            });
        }

        // Toggle route display
        async function toggleRoute() {
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
                document.getElementById('show-route-btn').innerHTML = '<i class="fas fa-route mr-1"></i> Route';
            } else {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/route/`);
                    const routeData = await response.json();
                    
                    const waypoints = routeData.waypoints.map(wp => [wp.latitude, wp.longitude]);
                    routeLayer = L.polyline(waypoints, {
                        color: '#3B82F6',
                        weight: 5,
                        opacity: 0.8,
                        dashArray: '15, 10'
                    }).addTo(map);
                    
                    document.getElementById('show-route-btn').innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Hide Route';
                } catch (error) {
                    console.error('Error loading route:', error);
                }
            }
        }

        // Toggle POIs (Points of Interest)
        async function togglePOIs() {
            if (poisVisible) {
                // Remove POI markers
                poiMarkers.forEach(marker => map.removeLayer(marker));
                poiMarkers = [];
                poisVisible = false;
                document.getElementById('show-pois-btn').innerHTML = '<i class="fas fa-gas-pump mr-1"></i> POIs';
            } else {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/route/`);
                    const routeData = await response.json();
                    
                    routeData.pois.forEach(poi => {
                        const iconClass = poi.type === 'gas_station' ? 'fas fa-gas-pump' : 'fas fa-coins';
                        const bgColor = poi.type === 'gas_station' ? 'bg-green-500' : 'bg-orange-500';
                        
                        const marker = L.marker([poi.latitude, poi.longitude], {
                            icon: L.divIcon({
                                html: `<div class="${bgColor} text-white rounded-full w-8 h-8 flex items-center justify-center text-sm shadow-lg"><i class="${iconClass}"></i></div>`,
                                className: 'poi-marker',
                                iconSize: [32, 32],
                                iconAnchor: [16, 16]
                            })
                        }).bindPopup(`
                            <div class="p-2">
                                <h4 class="font-bold">${poi.type === 'gas_station' ? '‚õΩ' : 'üõ£Ô∏è'} ${poi.name}</h4>
                                <p class="text-sm text-gray-600">${poi.type.replace('_', ' ').toUpperCase()}</p>
                            </div>
                        `).addTo(map);
                        
                        poiMarkers.push(marker);
                    });
                    
                    poisVisible = true;
                    document.getElementById('show-pois-btn').innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Hide POIs';
                } catch (error) {
                    console.error('Error loading POIs:', error);
                }
            }
        }

        // Update alerts panel with enhanced Indian context
        function updateAlertsPanel() {
            const alertsList = document.getElementById('alerts-list');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="text-center text-gray-500">‚úÖ All systems normal</div>';
                return;
            }

            // Sort alerts by severity
            const sortedAlerts = alerts.sort((a, b) => {
                const severityOrder = { 'critical': 0, 'high': 1, 'medium': 2, 'low': 3 };
                return severityOrder[a.severity] - severityOrder[b.severity];
            });

            alertsList.innerHTML = sortedAlerts.slice(0, 10).map(alert => {
                const severityClass = `alert-${alert.severity}`;
                const icons = {
                    'route_deviation': 'üõ£Ô∏è',
                    'extended_stop': '‚è±Ô∏è',
                    'speed_violation': 'üö®',
                    'low_fuel': '‚õΩ'
                };
                const icon = icons[alert.alert_type] || '‚ö†Ô∏è';

                return `
                    <div class="${severityClass} p-3 rounded border-l-4 ${alert.severity === 'critical' ? 'pulse-red' : ''}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h4 class="font-semibold text-sm flex items-center">
                                    <span class="mr-2">${icon}</span>
                                    ${alert.alert_type.replace('_', ' ').toUpperCase()}
                                    ${alert.severity === 'critical' ? '<span class="ml-2 bg-red-600 text-white px-2 py-1 rounded-full text-xs">CRITICAL</span>' : ''}
                                </h4>
                                <p class="text-sm text-gray-700 mt-1">${alert.message}</p>
                                <div class="flex items-center mt-2 text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${new Date(alert.timestamp).toLocaleString()}
                                    ${alert.driver_phone ? `<i class="fas fa-phone ml-3 mr-1"></i>${alert.driver_phone}` : ''}
                                </div>
                            </div>
                            <button onclick="acknowledgeAlert('${alert.id}')" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 ml-2">
                                Acknowledge
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update activity log with Indian context
        function updateActivityLog() {
            const activityLog = document.getElementById('activity-log');
            
            const activities = [];
            
            // Generate activities from vehicle data
            vehicles.forEach(vehicle => {
                if (vehicle.route_status === 'on_route' && vehicle.speed > 0) {
                    activities.push({
                        time: new Date(),
                        message: `${vehicle.vehicle_id} en route to Chandilkhol - ${vehicle.route_progress.toFixed(1)}% complete`,
                        type: 'success',
                        icon: 'üöõ'
                    });
                }
                if (vehicle.stop_duration > 0) {
                    activities.push({
                        time: new Date(Date.now() - (vehicle.stop_duration * 60000)),
                        message: `${vehicle.vehicle_id} stopped for ${vehicle.stop_duration} minutes`,
                        type: vehicle.stop_duration > 30 ? 'warning' : 'info',
                        icon: '‚è∏Ô∏è'
                    });
                }
                if (vehicle.fuel_level < 30) {
                    activities.push({
                        time: new Date(),
                        message: `${vehicle.vehicle_id} low fuel: ${vehicle.fuel_level.toFixed(1)}%`,
                        type: 'warning',
                        icon: '‚õΩ'
                    });
                }
            });

            // Add alert activities
            alerts.slice(0, 5).forEach(alert => {
                activities.push({
                    time: new Date(alert.timestamp),
                    message: alert.message,
                    type: 'alert',
                    icon: 'üö®'
                });
            });

            activities.sort((a, b) => b.time - a.time);

            if (activities.length === 0) {
                activityLog.innerHTML = '<div class="text-center text-gray-500">No recent activity</div>';
                return;
            }

            activityLog.innerHTML = activities.slice(0, 12).map(activity => {
                const typeClasses = {
                    'warning': 'bg-yellow-50 text-yellow-800 border-l-4 border-yellow-400',
                    'alert': 'bg-red-50 text-red-800 border-l-4 border-red-400',
                    'success': 'bg-green-50 text-green-800 border-l-4 border-green-400',
                    'info': 'bg-blue-50 text-blue-800 border-l-4 border-blue-400'
                };
                const typeClass = typeClasses[activity.type] || 'bg-gray-50 text-gray-800';

                return `
                    <div class="flex items-start space-x-3 p-3 rounded ${typeClass}">
                        <span class="text-lg">${activity.icon}</span>
                        <div class="flex-1">
                            <span class="text-sm font-medium">${activity.message}</span>
                            <div class="text-xs opacity-75 mt-1">${activity.time.toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show critical alert banner
        function showCriticalAlertBanner(message) {
            document.getElementById('critical-alert-message').textContent = message;
            document.getElementById('critical-alert-banner').classList.remove('hidden');
        }

        // Dismiss critical alert banner
        function dismissCriticalAlert() {
            document.getElementById('critical-alert-banner').classList.add('hidden');
        }

        // Focus on specific vehicle
        function focusVehicle(vehicleId) {
            const vehicle = vehicles.find(v => v.vehicle_id === vehicleId);
            if (vehicle && vehicleMarkers[vehicleId]) {
                map.setView([vehicle.latitude, vehicle.longitude], 14);
                vehicleMarkers[vehicleId].openPopup();
            }
        }

        // Center map on India route
        function centerMap() {
            map.setView([20.9100, 85.6500], 10);
        }

        // Acknowledge alert
        async function acknowledgeAlert(alertId) {
            try {
                await fetch(`${API_BASE_URL}/api/v1/alerts/${alertId}/acknowledge`, { method: 'POST' });
                refreshData();
            } catch (error) {
                console.error('Error acknowledging alert:', error);
            }
        }

        // Refresh all data
        function refreshData() {
            loadData();
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-md';
            errorDiv.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle mr-3 mt-1"></i>
                    <div>
                        <div class="font-bold">System Error</div>
                        <div class="text-sm">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">‚úï</button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 8000);
        }

        // Initial system check
        fetch(`${API_BASE_URL}/health`).then(response => {
            if (!response.ok) throw new Error('NTPC Fleet API not responding');
        }).catch(() => {
            showError('NTPC Fleet Management API is offline. Please contact IT support or ensure the backend server is running on port 8004.');
        });
    </script>
</body>
</html>
