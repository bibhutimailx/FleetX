<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Fleet Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .map-container {
            height: 500px;
            border-radius: 8px;
        }
        .alert-high {
            border-left: 4px solid #EF4444;
            background-color: #FEF2F2;
        }
        .alert-medium {
            border-left: 4px solid #F59E0B;
            background-color: #FFFBEB;
        }
        .alert-low {
            border-left: 4px solid #3B82F6;
            background-color: #EFF6FF;
        }
        .route-line {
            stroke: #3B82F6;
            stroke-width: 3;
            stroke-dasharray: 5,5;
            fill: none;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .blink {
            animation: blink 1s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Alert Banner -->
    <div id="alert-banner" class="hidden bg-red-600 text-white px-4 py-2 text-center">
        <span id="alert-message"></span>
        <button onclick="dismissAlert()" class="ml-4 text-white hover:text-gray-200">‚úï</button>
    </div>

    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold">üöõ Enhanced Fleet Management System</h1>
                <div class="flex items-center space-x-4">
                    <div class="text-sm">
                        <span class="bg-green-500 px-2 py-1 rounded text-xs">Live Tracking</span>
                        <span id="last-update" class="ml-2">Loading...</span>
                    </div>
                    <div id="alert-count" class="bg-red-500 px-2 py-1 rounded text-xs hidden">
                        0 Alerts
                    </div>
                    <button id="refresh-btn" class="bg-blue-500 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <!-- Enhanced Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-truck text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Total Fleet</p>
                        <p id="total-vehicles" class="text-xl font-bold">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-route text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">On Route</p>
                        <p id="on-route" class="text-xl font-bold text-green-600">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-pause text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Stopped</p>
                        <p id="stopped" class="text-xl font-bold text-yellow-600">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-boxes text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Loaded</p>
                        <p id="loaded-vehicles" class="text-xl font-bold text-purple-600">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Active Alerts</p>
                        <p id="active-alerts" class="text-xl font-bold text-red-600">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-indigo-100 rounded-lg">
                        <i class="fas fa-percentage text-indigo-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-gray-600">Avg Progress</p>
                        <p id="avg-progress" class="text-xl font-bold text-indigo-600">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route Map and Alerts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Enhanced Map -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">üó∫Ô∏è Route Tracking & Monitoring</h2>
                    <div class="flex space-x-2">
                        <button id="show-route-btn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            <i class="fas fa-route mr-1"></i> Show Route
                        </button>
                        <button id="center-map-btn" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                            <i class="fas fa-crosshairs mr-1"></i> Center
                        </button>
                    </div>
                </div>
                <div id="map" class="map-container"></div>
                <div class="mt-4 grid grid-cols-3 gap-4 text-sm">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span>Plant Stockyard</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                        <span>Destination</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                        <span>Route Path</span>
                    </div>
                </div>
            </div>

            <!-- Active Alerts Panel -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">üö® Active Alerts</h2>
                <div id="alerts-list" class="space-y-3">
                    <div class="text-center text-gray-500 pulse">Loading alerts...</div>
                </div>
            </div>
        </div>

        <!-- Vehicle Status and Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Vehicle Fleet Status -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">üöõ Fleet Status</h2>
                <div id="vehicle-list" class="space-y-3">
                    <div class="text-center text-gray-500 pulse">Loading vehicles...</div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">üìã Recent Activity</h2>
                <div id="activity-log" class="space-y-2">
                    <div class="text-center text-gray-500 pulse">Loading activity...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://127.0.0.1:8003';
        
        // Global variables
        let map;
        let vehicleMarkers = {};
        let vehicles = [];
        let alerts = [];
        let routeLayer;
        let plantMarker;
        let destinationMarker;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadData();
            setInterval(refreshData, 10000); // Refresh every 10 seconds
            
            // Event listeners
            document.getElementById('refresh-btn').addEventListener('click', refreshData);
            document.getElementById('show-route-btn').addEventListener('click', toggleRoute);
            document.getElementById('center-map-btn').addEventListener('click', centerMap);
        });

        // Initialize enhanced map
        function initializeMap() {
            map = L.map('map').setView([40.7479, -73.9855], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add plant stockyard marker
            plantMarker = L.marker([40.7128, -74.0060], {
                icon: L.divIcon({
                    html: '<div class="bg-green-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-lg font-bold shadow-lg"><i class="fas fa-industry"></i></div>',
                    className: 'plant-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                })
            }).bindPopup(`
                <div class="p-2">
                    <h3 class="font-bold text-green-600">üè≠ Plant Stockyard</h3>
                    <p>Material loading point</p>
                    <p class="text-sm text-gray-500">Starting location for all routes</p>
                </div>
            `).addTo(map);

            // Add destination marker
            destinationMarker = L.marker([40.7831, -73.9712], {
                icon: L.divIcon({
                    html: '<div class="bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-lg font-bold shadow-lg"><i class="fas fa-flag-checkered"></i></div>',
                    className: 'destination-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                })
            }).bindPopup(`
                <div class="p-2">
                    <h3 class="font-bold text-red-600">üèÅ Destination Site</h3>
                    <p>Material unloading point</p>
                    <p class="text-sm text-gray-500">Final destination for all routes</p>
                </div>
            `).addTo(map);
        }

        // Load all data
        async function loadData() {
            try {
                const [vehiclesResponse, alertsResponse, analyticsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/v1/vehicles/locations`),
                    fetch(`${API_BASE_URL}/api/v1/alerts/`),
                    fetch(`${API_BASE_URL}/api/v1/analytics/summary`)
                ]);
                
                const vehiclesData = await vehiclesResponse.json();
                const alertsData = await alertsResponse.json();
                const analyticsData = await analyticsResponse.json();
                
                vehicles = vehiclesData.locations || [];
                alerts = alertsData.alerts || [];
                
                updateDashboard(analyticsData);
                updateVehicleList();
                updateMap();
                updateAlertsPanel();
                updateActivityLog();
                
                document.getElementById('last-update').textContent = 
                    `Updated: ${new Date().toLocaleTimeString()}`;
                    
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data. Please check if the API server is running.');
            }
        }

        // Update dashboard
        function updateDashboard(analytics) {
            document.getElementById('total-vehicles').textContent = analytics.total_vehicles;
            document.getElementById('on-route').textContent = analytics.on_route;
            document.getElementById('stopped').textContent = analytics.stopped;
            document.getElementById('loaded-vehicles').textContent = analytics.loaded_vehicles;
            document.getElementById('active-alerts').textContent = analytics.active_alerts;
            document.getElementById('avg-progress').textContent = `${analytics.average_progress.toFixed(1)}%`;
            
            // Update alert count in header
            const alertCountEl = document.getElementById('alert-count');
            if (analytics.active_alerts > 0) {
                alertCountEl.textContent = `${analytics.active_alerts} Alerts`;
                alertCountEl.classList.remove('hidden');
                alertCountEl.classList.add('blink');
            } else {
                alertCountEl.classList.add('hidden');
                alertCountEl.classList.remove('blink');
            }
        }

        // Update vehicle list with enhanced info
        function updateVehicleList() {
            const vehicleList = document.getElementById('vehicle-list');
            
            if (vehicles.length === 0) {
                vehicleList.innerHTML = '<div class="text-center text-gray-500">No vehicles found</div>';
                return;
            }

            vehicleList.innerHTML = vehicles.map(vehicle => {
                const statusColor = {
                    'on_route': 'text-green-600',
                    'stopped': 'text-yellow-600',
                    'deviation': 'text-red-600'
                }[vehicle.route_status] || 'text-gray-600';

                const loadStatusIcon = {
                    'empty': 'üì¶',
                    'loading': '‚è≥',
                    'loaded': 'üìã',
                    'unloading': 'üîÑ'
                }[vehicle.load_status] || '‚ùì';

                return `
                    <div class="border rounded-lg p-3 hover:bg-gray-50 cursor-pointer" onclick="focusVehicle('${vehicle.vehicle_id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-semibold text-blue-600">${vehicle.vehicle_id}</h3>
                                <p class="text-sm text-gray-600">${vehicle.driver_name}</p>
                                <p class="text-xs text-gray-500">${vehicle.vehicle_type}</p>
                                <div class="flex items-center mt-1">
                                    <span class="text-sm ${statusColor}">${vehicle.route_status.replace('_', ' ').toUpperCase()}</span>
                                    <span class="ml-2 text-sm">${loadStatusIcon} ${vehicle.load_status}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center">
                                    <span class="w-2 h-2 rounded-full ${vehicle.speed > 0 ? 'bg-green-400' : 'bg-gray-400'} mr-1"></span>
                                    <span class="text-xs">${(vehicle.speed || 0).toFixed(1)} km/h</span>
                                </div>
                                <p class="text-sm font-medium">${vehicle.route_progress.toFixed(1)}% complete</p>
                                ${vehicle.stop_duration > 0 ? `<p class="text-xs text-red-500">Stopped: ${vehicle.stop_duration}m</p>` : ''}
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${vehicle.route_progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update map with enhanced markers
        function updateMap() {
            // Clear existing vehicle markers
            Object.values(vehicleMarkers).forEach(marker => map.removeLayer(marker));
            vehicleMarkers = {};

            // Add vehicle markers with status indicators
            vehicles.forEach(vehicle => {
                const statusColors = {
                    'on_route': 'bg-green-500',
                    'stopped': 'bg-yellow-500',
                    'deviation': 'bg-red-500'
                };
                
                const colorClass = statusColors[vehicle.route_status] || 'bg-gray-500';
                
                const icon = L.divIcon({
                    html: `
                        <div class="${colorClass} text-white rounded-full w-8 h-8 flex items-center justify-center text-xs font-bold shadow-lg">
                            ${vehicle.vehicle_id.slice(-2)}
                        </div>
                        ${vehicle.stop_duration > 30 ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full blink"></div>' : ''}
                    `,
                    className: 'vehicle-marker',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                const marker = L.marker([vehicle.latitude, vehicle.longitude], { icon })
                    .bindPopup(`
                        <div class="p-3">
                            <h3 class="font-bold text-blue-600">${vehicle.vehicle_id}</h3>
                            <p><strong>Driver:</strong> ${vehicle.driver_name}</p>
                            <p><strong>Status:</strong> <span class="text-${vehicle.route_status === 'on_route' ? 'green' : vehicle.route_status === 'stopped' ? 'yellow' : 'red'}-600">${vehicle.route_status.replace('_', ' ').toUpperCase()}</span></p>
                            <p><strong>Load:</strong> ${vehicle.load_status.toUpperCase()}</p>
                            <p><strong>Speed:</strong> ${(vehicle.speed || 0).toFixed(1)} km/h</p>
                            <p><strong>Progress:</strong> ${vehicle.route_progress.toFixed(1)}%</p>
                            ${vehicle.stop_duration > 0 ? `<p><strong>Stopped:</strong> <span class="text-red-600">${vehicle.stop_duration} minutes</span></p>` : ''}
                            <p class="text-xs text-gray-500 mt-1">
                                ETA: ${vehicle.destination_eta ? new Date(vehicle.destination_eta).toLocaleTimeString() : 'N/A'}
                            </p>
                        </div>
                    `)
                    .addTo(map);

                vehicleMarkers[vehicle.vehicle_id] = marker;
            });
        }

        // Update alerts panel
        function updateAlertsPanel() {
            const alertsList = document.getElementById('alerts-list');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="text-center text-gray-500">‚úÖ No active alerts</div>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => {
                const severityClass = `alert-${alert.severity}`;
                const icon = {
                    'route_deviation': 'üõ£Ô∏è',
                    'extended_stop': '‚è±Ô∏è',
                    'speed_violation': '‚ö°'
                }[alert.alert_type] || '‚ö†Ô∏è';

                return `
                    <div class="${severityClass} p-3 rounded border-l-4">
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="font-semibold text-sm">${icon} ${alert.alert_type.replace('_', ' ').toUpperCase()}</h4>
                                <p class="text-sm text-gray-700 mt-1">${alert.message}</p>
                                <p class="text-xs text-gray-500 mt-1">${new Date(alert.timestamp).toLocaleString()}</p>
                            </div>
                            <button onclick="acknowledgeAlert('${alert.id}')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                Acknowledge
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Show alert banner for high severity alerts
            const highAlerts = alerts.filter(a => a.severity === 'high');
            if (highAlerts.length > 0) {
                showAlertBanner(highAlerts[0].message);
            }
        }

        // Update activity log
        function updateActivityLog() {
            const activityLog = document.getElementById('activity-log');
            
            const activities = [];
            
            // Add vehicle activities
            vehicles.forEach(vehicle => {
                if (vehicle.route_status === 'stopped' && vehicle.stop_duration > 0) {
                    activities.push({
                        time: new Date(),
                        message: `${vehicle.vehicle_id} stopped for ${vehicle.stop_duration} minutes`,
                        type: vehicle.stop_duration > 30 ? 'warning' : 'info'
                    });
                }
                if (vehicle.route_status === 'on_route' && vehicle.speed > 0) {
                    activities.push({
                        time: new Date(),
                        message: `${vehicle.vehicle_id} en route - ${vehicle.route_progress.toFixed(1)}% complete`,
                        type: 'success'
                    });
                }
            });

            // Add alert activities
            alerts.slice(0, 3).forEach(alert => {
                activities.push({
                    time: new Date(alert.timestamp),
                    message: `Alert: ${alert.message}`,
                    type: 'alert'
                });
            });

            activities.sort((a, b) => b.time - a.time);

            if (activities.length === 0) {
                activityLog.innerHTML = '<div class="text-center text-gray-500">No recent activity</div>';
                return;
            }

            activityLog.innerHTML = activities.slice(0, 8).map(activity => {
                const typeClass = {
                    'warning': 'bg-yellow-50 text-yellow-800',
                    'alert': 'bg-red-50 text-red-800',
                    'success': 'bg-green-50 text-green-800',
                    'info': 'bg-blue-50 text-blue-800'
                }[activity.type] || 'bg-gray-50 text-gray-800';

                return `
                    <div class="flex items-start space-x-3 p-2 rounded ${typeClass}">
                        <span class="text-xs font-mono">${activity.time.toLocaleTimeString()}</span>
                        <span class="text-sm">${activity.message}</span>
                    </div>
                `;
            }).join('');
        }

        // Toggle route display
        async function toggleRoute() {
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
                document.getElementById('show-route-btn').innerHTML = '<i class="fas fa-route mr-1"></i> Show Route';
            } else {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/route/`);
                    const routeData = await response.json();
                    
                    const waypoints = routeData.waypoints.map(wp => [wp.latitude, wp.longitude]);
                    routeLayer = L.polyline(waypoints, {
                        color: '#3B82F6',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(map);
                    
                    document.getElementById('show-route-btn').innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Hide Route';
                } catch (error) {
                    console.error('Error loading route:', error);
                }
            }
        }

        // Center map on all vehicles
        function centerMap() {
            if (vehicles.length > 0) {
                const group = new L.featureGroup([
                    ...Object.values(vehicleMarkers),
                    plantMarker,
                    destinationMarker
                ]);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Focus on specific vehicle
        function focusVehicle(vehicleId) {
            const vehicle = vehicles.find(v => v.vehicle_id === vehicleId);
            if (vehicle && vehicleMarkers[vehicleId]) {
                map.setView([vehicle.latitude, vehicle.longitude], 15);
                vehicleMarkers[vehicleId].openPopup();
            }
        }

        // Acknowledge alert
        async function acknowledgeAlert(alertId) {
            try {
                await fetch(`${API_BASE_URL}/api/v1/alerts/${alertId}/acknowledge`, { method: 'POST' });
                refreshData();
            } catch (error) {
                console.error('Error acknowledging alert:', error);
            }
        }

        // Show alert banner
        function showAlertBanner(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-banner').classList.remove('hidden');
        }

        // Dismiss alert banner
        function dismissAlert() {
            document.getElementById('alert-banner').classList.add('hidden');
        }

        // Refresh all data
        function refreshData() {
            loadData();
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">‚úï</button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // Initial health check
        fetch(`${API_BASE_URL}/health`).then(response => {
            if (!response.ok) throw new Error('API not responding');
        }).catch(() => {
            showError('API server is not responding. Please ensure the backend is running on port 8003.');
        });
    </script>
</body>
</html>
